name: Deploy IP Address Tracker

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get all history for debugging

      - name: Debug - Show script.js before
        run: |
          echo "=== script.js BEFORE injection ==="
          head -3 script.js
          echo "=== Searching for placeholder ==="
          grep -n "{{IPIFY_API_KEY}}" script.js || echo "Placeholder not found!"

      - name: Inject API Key (FIXED VERSION)
        run: |
          # FIRST: Check file exists and has placeholder
          if [ ! -f "script.js" ]; then
            echo "❌ ERROR: script.js not found!"
            exit 1
          fi

          if ! grep -q "{{IPIFY_API_KEY}}" script.js; then
            echo "❌ ERROR: Placeholder {{IPIFY_API_KEY}} not found in script.js!"
            echo "First 5 lines of script.js:"
            head -5 script.js
            exit 1
          fi

          # Backup original
          cp script.js script.js.original

          # INJECT THE KEY - Use double quotes for sed
          sed -i "s|{{IPIFY_API_KEY}}|${{ secrets.IPIFY_API_KEY }}|g" script.js

          echo "✅ API Key injected successfully"

      - name: Debug - Show script.js after
        run: |
          echo "=== script.js AFTER injection ==="
          head -3 script.js
          echo "=== Verifying injection ==="

          # Check if placeholder is gone
          if grep -q "{{IPIFY_API_KEY}}" script.js; then
            echo "❌ FAILED: Placeholder still present!"
            exit 1
          fi

          # Check if real key was inserted (show masked)
          if grep -q "at_" script.js; then
            echo "✅ SUCCESS: Real API key detected (masked):"
            grep "at_" script.js | sed 's/at_.*/at_**********/'
          else
            echo "❌ FAILED: No API key found after injection"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
