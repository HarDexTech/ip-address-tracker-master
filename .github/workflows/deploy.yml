name: Deploy IP Tracker

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show current script.js
        run: |
          echo "=== Current script.js (first 3 lines) ==="
          head -3 script.js
          echo "=== Looking for placeholder ==="
          if grep -q "{{IPIFY_API_KEY}}" script.js; then
            echo "✅ Placeholder found!"
          else
            echo "❌ Placeholder NOT found!"
            exit 1
          fi

      - name: Inject API Key (FIXED)
        run: |
          echo "=== Injecting API key ==="

          # METHOD 1: Simple string replacement (most reliable)
          # Read the entire file
          CONTENT=$(cat script.js)
          # Replace placeholder with secret
          CONTENT="${CONTENT//'{{IPIFY_API_KEY}}'/${{ secrets.IPIFY_API_KEY }}}"
          # Write back
          echo "$CONTENT" > script.js

          echo "✅ Key injected"
          echo "First line after injection:"
          head -1 script.js | sed 's/at_.*/at_**********/'

      - name: Verify Injection
        run: |
          echo "=== Verifying ==="
          if grep -q "${{ secrets.IPIFY_API_KEY }}" script.js; then
            echo "✅ SUCCESS: Real API key is in script.js"
            # Show masked version
            grep "const API_KEY = " script.js | head -1 | sed 's/at_.*/at_**********/'
          else
            echo "❌ FAILED: Real key not found after injection!"
            echo "Current first line:"
            head -1 script.js
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
