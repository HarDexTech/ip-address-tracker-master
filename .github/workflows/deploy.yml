name: Deploy IP Address Tracker

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Inject API Key into script.js
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Listing files ==="
          ls -la

          echo "=== Checking script.js ==="
          if [ -f "script.js" ]; then
            echo "✓ Found script.js in root directory"
            
            # Check if placeholder exists
            if grep -q "'{{IPIFY_API_KEY}}'" script.js; then
              echo "✓ Placeholder found, injecting API key..."
              sed -i "s/'{{IPIFY_API_KEY}}'/'${{ secrets.IPIFY_API_KEY }}'/" script.js
              echo "✅ API key injected successfully!"
            else
              echo "⚠️ Warning: Placeholder '{{IPIFY_API_KEY}}' not found in script.js"
              echo "First 5 lines of script.js:"
              head -5 script.js
            fi
          else
            echo "❌ ERROR: script.js not found in root directory!"
            echo "Looking for JavaScript files..."
            find . -name "*.js" -type f | head -10
            exit 1
          fi

      - name: Build with Jekyll (for GitHub Pages compatibility)
        run: |
          # Create a basic Jekyll config to bypass Jekyll processing
          echo "Created .nojekyll to disable Jekyll processing"
          touch .nojekyll

          # Create a basic index.html if it doesn't exist (but yours does)
          if [ ! -f "index.html" ]; then
            echo "<h1>IP Address Tracker</h1><p>Built with GitHub Actions</p>" > index.html
          fi

          echo "=== Final file list ==="
          ls -la

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v4 # CHANGED: Updated from v2 to v4
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # CHANGED: Updated from v2 to v4
